const express = require('express');
const { uniqBy } = require('lodash');

const jsonApiWrapper = require('app/utils/jsonApiWrapper');
const prizesController = require('app/controllers/prizes');
const authenticationController = require('app/controllers/authentication');
const usersController = require('app/controllers/users');
const categoriesController = require('app/controllers/categories');

module.exports = (service) => {
  const router = express.Router();

  const prizes = prizesController(service);
  const users = usersController(service);
  const auth = authenticationController(service);
  const categories = categoriesController(service);

  router.post('/authenticate', jsonApiWrapper(auth.authenticateUser)('token'));

  router.get('/prizes', jsonApiWrapper(prizes.getAll)('prize'));
  router.get('/categories', jsonApiWrapper(categories.getAll)('category'));

  router.get('/users/me', auth.authMiddleware, jsonApiWrapper(users.get)('user'));
  router.post('/users/me/tickets', auth.authMiddleware, jsonApiWrapper(users.commitTicket)('ticket'));

  router.get('/users/me/prizes', auth.authMiddleware, jsonApiWrapper(users.getPrizes)('user_prize'));

  router.get('/', (req, res) => {
    const routes = uniqBy(router.stack.map((r) => r.route.path));

    res.json({
      data: {
        type: 'Root',
        included: {},
        meta: {},
        links: routes.map((route) => ({ path: `${req.apiBase}${route}` })),
      },
    });
  });

  return router;
};
