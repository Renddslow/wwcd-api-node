const {
  NotFoundError,
} = require('app/errors');

module.exports = (service) => ({
  getAll: async () => {
    const prizes = await service.db.query(`
      SELECT id, category_id, title, description, image, committed_tickets
      FROM PRIZES P 
        JOIN (SELECT prize_id, COUNT(*) AS committed_tickets FROM TICKETS GROUP BY prize_id) T
        ON P.id = T.prize_id
    `);

    return prizes;
  },
  get: async ({ id }) => {
    const prizes = await service.db.query(`
      SELECT id, category_id, title, description, image, committed_tickets
      FROM PRIZES P
        JOIN (SELECT prize_id, COUNT(*) AS committed_tickets FROM TICKETS WHERE prize_id = ? GROUP BY prize_id) T
        ON P.id = T.prize_id
      WHERE P.id = ?
    `, [id, id]);

    if (prizes.length === 0) {
      throw new NotFoundError();
    }

    return prizes[0];
  },
  getDiffs: async (p, { since }) => {
    const prizesWithNewTickets = await service.db.query(`
      SELECT id, category_id, title, description, image, committed_tickets
      FROM PRIZES P
        INNER JOIN (
          SELECT prize_id, COUNT(*) AS committed_tickets
          FROM TICKETS
          WHERE prize_id IN (SELECT prize_id FROM TICKETS WHERE created > ?)
          GROUP BY prize_id
        ) T
        ON P.id = T.prize_id
    `, new Date(since).toISOString().
        replace(/T/, ' ').      // replace T with a space
        replace(/\..+/, '')     // delete the dot and everything after
    );

    return prizesWithNewTickets;
  },
});