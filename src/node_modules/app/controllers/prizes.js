const { sample } = require('lodash');

const {
  NotFoundError,
} = require('app/errors');

module.exports = (service) => ({
  getAll: async () => {
    const prizes = await service.db.collection('prizes')
      .get();

    return Promise.all(prizes.docs.map(async (d) => {
      const prize = Object.assign({}, d.data(), {
        id: d.id,
      });

      const tickets = await service.db.collection('tickets')
        .where('prize', '==', service.db.doc(`prizes/${prize.id}`))
        .get();
      prize.committedTickets = tickets.docs.length;
      return prize;
    }));
  },
  pickWinner: async ({ id: prizeId }) => {
    const prize = await service.db.collection('prizes').doc(prizeId).get();

    if (!prize) {
      throw new NotFoundError();
    }

    const tickets = await service.db.collection('tickets')
      .where('prize', '==', service.db.doc(`prizes/${prizeId}`))
      .get();

    const ticketOptions = await Promise.all(tickets.docs.map(async (ticket) => {
      const user = await ticket.data().user.get();
      return Object.assign({}, user.data(), { id: user.id });
    }));

    const winner = sample(ticketOptions);

    return Object.assign({}, winner, {
      prize: Object.assign({}, prize.data(), { id: prizeId })
    });
  },
  commitWinner: async ({ id: prizeId }) => {

  },
});